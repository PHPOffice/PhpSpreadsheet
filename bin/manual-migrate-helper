#!/usr/bin/php
<?php

/**
 * Helper script for manually upgrading PHPExcel tp PhpSpreadsheet.
 * Does basic string searching and then tells you where to look for info on how to fix possible issues.
 * Run from the Command Line:
 * /path/to/script /path/to/page/to/check.php
 * 
 * @author Pamblam
 * @license WTFPL
 */

$file = $argv[1];
if(!file_exists($file) || !is_readable($file) || !is_file($file)){
	echo "File doesn't exists or is not readable: $file";
	exit;
}

$strings = array(
	'Renamed readers and writers' => array(
		'IOFactory::createReader',
		'IOFactory::createWriter',
		'IOFactory::identify',
	),
	'Simplified IOFactory' => array(
		'getSearchLocations',
		'setSearchLocations',
		'addSearchLocation',
	),
	'Removed deprecated things' => array(
		'duplicateStyleArray',
		'dataTypeForValue',
		'getCondition',
		'setCondition',
		'getDefaultStyle',
		'setDefaultStyle',
		'setSharedStyle',
		'getSelectedCell',
		'setTempDir',
	),
	'Autoloader' => array(
		'PHPExcel_Autoloader',
		'common/PHPExcel_1.7.8',
	),
	'Writing PDF' => array(
		'getPdfRenderer',
		'setPdfRenderer',
		'getPdfRendererName',
		'setPdfRendererName',
	),
	'Rendering charts' => array(
		'CHART_RENDERER_JPGRAPH',
	),
	'PclZip and ZipArchive' => array(
		'PclZip',
		'setZipClass',
		'getZipClass',
		'PHPExcel_Shared_ZipArchive',
		'PHPExcel_Shared_ZipStreamWrapper',
	),
	'Cell caching' => array(
		'PHPExcel_CachedObjectStorage_APC',
		'PHPExcel_CachedObjectStorage_DiscISAM',
		'PHPExcel_CachedObjectStorage_ICache',
		'PHPExcel_CachedObjectStorage_Igbinary',
		'PHPExcel_CachedObjectStorage_Memcache',
		'PHPExcel_CachedObjectStorage_Memory',
		'PHPExcel_CachedObjectStorage_MemoryGZip',
		'PHPExcel_CachedObjectStorage_MemorySerialized',
		'PHPExcel_CachedObjectStorage_PHPTemp',
		'PHPExcel_CachedObjectStorage_SQLite',
		'PHPExcel_CachedObjectStorage_SQLite3',
		'PHPExcel_CachedObjectStorage_Wincache',
		'getCellCollection',
		'getCoordinates',
		'getCellCacheController',
	),
	'Dropped conditionally returned cell' => array(
		'setCellValue',
		'setCellValueByColumnAndRow',
		'setCellValueExplicit',
		'setCellValueExplicitByColumnAndRow',
		'addRule',
	),
	'Dedicated class to manipulate coordinates' => array(
		'PHPExcel_Cell',
	),
	'Column index based on 1' => array(
		'cellExistsByColumnAndRow',
		'freezePaneByColumnAndRow',
		'getCellByColumnAndRow',
		'getColumnDimensionByColumn',
		'getCommentByColumnAndRow',
		'getStyleByColumnAndRow',
		'insertNewColumnBeforeByIndex',
		'mergeCellsByColumnAndRow',
		'protectCellsByColumnAndRow',
		'removeColumnByIndex',
		'setAutoFilterByColumnAndRow',
		'setBreakByColumnAndRow',
		'setCellValueByColumnAndRow',
		'setCellValueExplicitByColumnAndRow',
		'setSelectedCellByColumnAndRow',
		'stringFromColumnIndex',
		'unmergeCellsByColumnAndRow',
		'unprotectCellsByColumnAndRow',
		'addPrintAreaByColumnAndRow',
		'setPrintAreaByColumnAndRow',
	),
	'Removed default values' => array(
		'setWriteDebugLog',
		'setEchoDebugLog',
		'setCalculationCacheEnabled',
		'setLocale',
		'setTokenType',
		'setTokenSubType',
		'setValue',
		'setValueExplicit',
		'setCalculatedValue',
		'setDataType',
		'isInRange',
		'coordinateFromString',
		'absoluteReference',
		'absoluteCoordinate',
		'splitRange',
		'rangeBoundaries',
		'rangeDimension',
		'getRangeBoundaries',
		'columnIndexFromString',
		'stringFromColumnIndex',
		'extractAllCellReferencesInRange',
		'setXfIndex',
		'checkString',
		'checkErrorCode',
		'setFormula1',
		'setFormula2',
		'setType',
		'setErrorStyle',
		'setOperator',
		'setAllowBlank',
		'setShowDropDown',
		'setShowInputMessage',
		'setShowErrorMessage',
		'setErrorTitle',
		'setError',
		'setPromptTitle',
		'setPrompt',
		'dataTypeForValue',
		'setUrl',
		'setTooltip',
		'setPlotVisibleOnly',
		'setDisplayBlanksAs',
		'setTopLeftOffset',
		'setBottomRightOffset',
		'setPlotType',
		'setPlotGrouping',
		'setPlotDirection',
		'setPlotStyle',
		'setSmoothLine',
		'setDataType',
		'getDataSource',
		'setDataSource',
		'getPointMarker',
		'setPointMarker',
		'getFormatCode',
		'setFormatCode',
		'getDataValue',
		'setDataValues',
		'stripNulls',
		'refresh',
		'getPosition',
		'setPosition',
		'getPositionXL',
		'setPositionXL',
		'getOverlay',
		'setOverlay',
		'getPlotGroupByIndex',
		'setPlotSeries',
		'getCaption',
		'setCaption',
		'getAuthor',
		'setAuthor',
		'getWidth',
		'setWidth',
		'getHeight',
		'setHeight',
		'getMarginLeft',
		'setMarginLeft',
		'getMarginTop',
		'setMarginTop',
		'getVisible',
		'setVisible',
		'getFillColor',
		'setAlignment',
		'getCreator',
		'setCreator',
		'getLastModifiedBy',
		'setLastModifiedBy',
		'getCreated',
		'setCreated',
		'getModified',
		'setModified',
		'getTitle',
		'setTitle',
		'getDescription',
		'setDescription',
		'getSubject',
		'setSubject',
		'getKeywords',
		'setKeywords',
		'getCategory',
		'setCategory',
		'getCompany',
		'setCompany',
		'getManager',
		'setManager',
		'getLockRevision',
		'setLockRevision',
		'getLockStructure',
		'setLockStructure',
		'getLockWindows',
		'setLockWindows',
		'getRevisionsPassword',
		'setRevisionsPassword',
		'getWorkbookPassword',
		'setWorkbookPassword',
		'addFromSource',
		'count',
		'getIndexForHashCode',
		'getByIndex',
		'getByHashCode',
		'setSearchLocations',
		'addSearchLocation',
		'createWriter',
		'createReader',
		'getName',
		'setName',
		'getRange',
		'setRange',
		'getLocalOnly',
		'setLocalOnly',
		'getReadDataOnly',
		'setReadDataOnly',
		'getReadEmptyCells',
		'setReadEmptyCells',
		'getIncludeCharts',
		'setIncludeCharts',
		'getLoadSheetsOnly',
		'setLoadSheetsOnly',
		'setInputEncoding',
		'getDelimiter',
		'setDelimiter',
		'getEnclosure',
		'setEnclosure',
		'getSheetIndex',
		'setSheetIndex',
		'setContiguous',
		'parseBorderAttributes',
		'parseRichText',
		'load',
		'flushCell',
		'scanElementForText',
		'canRead',
		'getInt4d',
		'readBorder',
		'toCSSArray',
		'boolean',
		'readChart',
		'chartTitle',
		'chartDataSeriesValuesMultiLevel',
		'getColourSchemeName',
		'getColourByIndex',
		'convertStringEncoding',
		'addText',
		'createText',
		'createTextRun',
		'getRichTextElements',
		'setRichTextElements',
		'getText',
		'setText',
		'setLocale',
		'getPdfRendererName',
		'setLibXmlLoaderOptions',
		'numberToName',
		'validateTimeZone',
		'excelToDateTimeObject',
		'excelToTimestamp',
		'PHPToExcel',
		'dateTimeToExcel',
		'timestampToExcel',
		'isDateTimeFormat',
		'isDateTimeFormatCode',
		'stringToExcel',
		'pixelsToEMU',
		'EMUToPixels',
		'cellDimensionToPixels',
		'pixelsToPoints',
		'pointsToPixels',
		'degreesToAngle',
		'angleToDegrees',
		'getParent',
		'setSpgr',
		'getOPTCollection',
		'setStartCoordinates',
		'getStartCoordinates',
		'setStartOffsetX',
		'getStartOffsetX',
		'setStartOffsetY',
		'getStartOffsetY',
		'setEndCoordinates',
		'getEndCoordinates',
		'setEndOffsetX',
		'getEndOffsetX',
		'setEndOffsetY',
		'setUseUploadTempDirectory',
		'setAutoSizeMethod',
		'getAutoSizeMethod',
		'setTrueTypeFontPath',
		'getTextWidthPixelsApprox',
		'fontSizeToPixels',
		'inchSizeToPixels',
		'centimeterSizeToPixels',
		'isSPD',
		'getL',
		'solve',
		'JAMAError',
		'ascToUcs',
		'localDateToOLE',
		'hashPassword',
		'buildCharacterSets',
		'controlCharacterOOXML2PHP',
		'controlCharacterPHP2OOXML',
		'sanitizeUTF8',
		'isUTF8',
		'countCharacters',
		'substring',
		'strToUpper',
		'strToLower',
		'strToTitle',
		'mbStrSplit',
		'strCaseReverse',
		'getDecimalSeparator',
		'setDecimalSeparator',
		'getThousandsSeparator',
		'setThousandsSeparator',
		'getCurrencyCode',
		'setCurrencyCode',
		'SYLKtoUTF8',
		'hasMacros',
		'setHasMacros',
		'setMacrosCode',
		'getMacrosCode',
		'setMacrosCertificate',
		'discardMacros',
		'setRibbonXMLData',
		'getRibbonXMLData',
		'setRibbonBinObjects',
		'getExtensionOnly',
		'getRibbonBinObjects',
		'sheetCodeNameExists',
		'getSheetByCodeName',
		'createSheet',
		'addSheet',
		'removeSheetByIndex',
		'getSheet',
		'getAllSheets',
		'getSheetByName',
		'getActiveSheetIndex',
		'setActiveSheetIndex',
		'setActiveSheetIndexByName',
		'getCellXfCollection',
		'getCellXfByIndex',
		'getCellXfByHashCode',
		'cellXfExists',
		'addCellXf',
		'removeCellXfByIndex',
		'getCellStyleXfCollection',
		'getCellStyleXfByIndex',
		'getCellStyleXfByHashCode',
		'addCellStyleXf',
		'removeCellStyleXfByIndex',
		'getStyleArray',
		'applyFromArray',
		'getHorizontal',
		'setHorizontal',
		'getVertical',
		'setVertical',
		'getTextRotation',
		'setTextRotation',
		'getWrapText',
		'setWrapText',
		'getShrinkToFit',
		'setShrinkToFit',
		'getIndent',
		'setIndent',
		'getReadorder',
		'setReadorder',
		'getBorderStyle',
		'setBorderStyle',
		'getDiagonalDirection',
		'setDiagonalDirection',
		'getARGB',
		'setARGB',
		'getRGB',
		'setRGB',
		'getConditionType',
		'setConditionType',
		'getOperatorType',
		'setOperatorType',
		'setConditions',
		'addCondition',
		'getFillType',
		'setFillType',
		'getRotation',
		'setRotation',
		'getSize',
		'setSize',
		'getBold',
		'setBold',
		'getItalic',
		'setItalic',
		'getSuperScript',
		'setSuperScript',
		'getSubScript',
		'setSubScript',
		'getUnderline',
		'setUnderline',
		'getStrikethrough',
		'setStrikethrough',
		'getBuiltInFormatCode',
		'setBuiltInFormatCode',
		'complexNumberFormatMask',
		'toFormattedString',
		'getLocked',
		'setLocked',
		'getHidden',
		'setHidden',
		'getColumn',
		'getColumnByOffset',
		'clearColumn',
		'shiftColumn',
		'getFilterType',
		'setFilterType',
		'getJoin',
		'setJoin',
		'setAttributes',
		'setAttribute',
		'getAttributes',
		'createRule',
		'addRule',
		'getRuleType',
		'setRuleType',
		'getValue',
		'setValue',
		'getOperator',
		'setOperator',
		'getGrouping',
		'setGrouping',
		'setRule',
		'getCoordinates',
		'setCoordinates',
		'getOffsetX',
		'setOffsetX',
		'getOffsetY',
		'setOffsetY',
		'setWidthAndHeight',
		'getResizeProportional',
		'setResizeProportional',
		'getIterateOnlyExistingCells',
		'setIterateOnlyExistingCells',
		'getAutoSize',
		'setAutoSize',
		'getCollapsed',
		'setCollapsed',
		'getXfIndex',
		'setXfIndex',
		'getPath',
		'setPath',
		'getBlurRadius',
		'setBlurRadius',
		'getDistance',
		'setDistance',
		'getDirection',
		'setDirection',
		'getAlignment',
		'getAlpha',
		'setAlpha',
		'getDifferentOddEven',
		'setDifferentOddEven',
		'getDifferentFirst',
		'setDifferentFirst',
		'getScaleWithDocument',
		'setScaleWithDocument',
		'getAlignWithMargins',
		'setAlignWithMargins',
		'getImageResource',
		'setImageResource',
		'getRenderingFunction',
		'setRenderingFunction',
		'getMimeType',
		'setMimeType',
		'getPaperSize',
		'setPaperSize',
		'getOrientation',
		'setOrientation',
		'getScale',
		'setScale',
		'getFitToPage',
		'setFitToPage',
		'getFitToHeight',
		'setFitToHeight',
		'getFitToWidth',
		'setFitToWidth',
		'getColumnsToRepeatAtLeft',
		'setColumnsToRepeatAtLeft',
		'setColumnsToRepeatAtLeftByStartAndEnd',
		'getRowsToRepeatAtTop',
		'setRowsToRepeatAtTop',
		'setRowsToRepeatAtTopByStartAndEnd',
		'getHorizontalCentered',
		'setHorizontalCentered',
		'getVerticalCentered',
		'setVerticalCentered',
		'getFirstPageNumber',
		'setFirstPageNumber',
		'setSheet',
		'getObjects',
		'setObjects',
		'getScenarios',
		'setScenarios',
		'getFormatCells',
		'setFormatCells',
		'getFormatColumns',
		'setFormatColumns',
		'getFormatRows',
		'setFormatRows',
		'getInsertColumns',
		'setInsertColumns',
		'getInsertRows',
		'setInsertRows',
		'getInsertHyperlinks',
		'setInsertHyperlinks',
		'getDeleteColumns',
		'setDeleteColumns',
		'getDeleteRows',
		'setDeleteRows',
		'getSelectLockedCells',
		'setSelectLockedCells',
		'getSort',
		'setSort',
		'getAutoFilter',
		'setAutoFilter',
		'getPivotTables',
		'setPivotTables',
		'getSelectUnlockedCells',
		'setSelectUnlockedCells',
		'getPassword',
		'setPassword',
		'getRowHeight',
		'setRowHeight',
		'getZeroHeight',
		'setZeroHeight',
		'getZoomScale',
		'setZoomScale',
		'getZoomScaleNormal',
		'setZoomScaleNormal',
		'getView',
		'setView',
		'getPreCalculateFormulas',
		'setPreCalculateFormulas',
		'getUseDiskCaching',
		'setUseDiskCaching',
		'getDiskCachingDirectory',
		'save',
		'getLineEnding',
		'setLineEnding',
		'getUseBOM',
		'setUseBOM',
		'getIncludeSeparatorLine',
		'setIncludeSeparatorLine',
		'getExcelCompatibility',
		'setExcelCompatibility',
		'writeLine',
		'getGenerateSheetNavigationBlock',
		'setGenerateSheetNavigationBlock',
		'getImagesRoot',
		'setImagesRoot',
		'getEmbedImages',
		'setEmbedImages',
		'getUseInlineCss',
		'setUseInlineCss',
		'getWriterPart',
		'getTempDir',
		'setTempDir',
		'prepareForSave',
		'setPaletteXl97',
		'writeWorkbook',
		'close',
		'writeBIFF8CellRangeAddressFixed',
		'getOffice2003Compatibility',
		'setOffice2003Compatibility',
		'writeContentTypes',
		'getImageMimeType',
		'createStringTable',
		'writeStringTable',
		'writeRichTextForCharts',
		'flipStringTable',
		'testClearRange',
		'testGetColumnIfNotSet',
		'testGetColumnWithoutRangeSet',
		'testClearRangeWithExistingColumns',
	)
);

$check = array();
$code = file_get_contents($file);
$lines = explode("\n", $code);
foreach($lines as $line_no => $line){
	$line_no = $line_no+1;
	foreach($strings as $header=>$string_list){
		foreach($string_list as $string){
			if(($pos = strpos($line, $string)) !== false){
				if(empty($check[$line_no])) $check[$line_no] = array();
				$check[$line_no][] = array(
					'position' => $pos,
					'header' => $header,
					'found' => $string
				);
			}
		}
	}
}

if(empty($check)){
	echo "This file appears to be ok!";
}else{
	ksort($check);
	echo count($check)." possible issues found... \n";
	echo "Refer to the following page to manually address the found possible issues:\n";
	echo "https://phpspreadsheet.readthedocs.io/en/develop/topics/migration-from-PHPExcel/#manual-changes\n";
	echo "-----------------\n";
	foreach($check as $line=>$problems){
		foreach($problems as $details){
			echo "---\n";
			echo " - Line: $line\n";
			echo " - Position: {$details['position']}\n";
			echo " - Found: {$details['found']}\n";
			echo " - Look under the header \"{$details['header']}\" for info on how to address this.\n";
			echo "---\n";
		}
	}
}






